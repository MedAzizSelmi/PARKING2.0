<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard - Parking</title>
  <script src="https://maps.gomaps.pro/maps/api/js?key=AlzaSyoHzeVrEcTuZehYbvYwJegoAgjhO5aCppn"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <style>
    #map {
      height: 500px;
      width: 100%;
    }
    .widget {
      display: none;
      position: absolute;
      top: 100px;
      left: 50px;
      background-color: white;
      padding: 20px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .widget.active {
      display: block;
    }
    .btn-disabled {
      pointer-events: none;
      opacity: 0.6;
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="#">Parking</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link active" th:href="@{/dashboard}" href="#">Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" th:href="@{/auth/profile/edit}" href="#">Profile</a>
        </li>
        <li class="nav-item">
          <form action="#" th:action="@{/auth/logout}" method="post" style="display:inline;">
            <button type="submit" class="nav-link btn btn-link">Logout</button>
          </form>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Dashboard Section -->
<section class="container my-5">
  <h1 class="text-center mb-4">Welcome to Your Dashboard</h1>
  <div class="text-center">
    <p>Reserve a parking spot in the nearest location.</p>
  </div>
</section>

<!-- Map Section -->
<div id="map"></div>

<!-- Widget Section -->
<div id="widget" class="widget">
  <h3>Zone Information</h3>
  <p id="zone-description"></p>
  <p id="zone-price"></p>
  <p id="zone-total-spots"></p>
  <p id="zone-available-spots"></p>
  <button id="reserve-button" class="btn btn-primary btn-disabled">Reserve</button>
  <button id="close-button" class="btn btn-secondary">Close</button>
</div>

<script>
  let selectedZone = null;
  let userLocation = null;
  let map = null;

  // Fetch zones from the backend
  async function fetchZones() {
    try {
      const response = await fetch('http://localhost:1234/api/zones');
      return await response.json();
    } catch (error) {
      console.error('Error fetching zones:', error);
      return [];
    }
  }

  // Initialize the map
  function initMap() {
    const defaultCenter = { lat: 36.8065, lng: 10.1815 }; // Tunis coordinates
    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 14,
      center: defaultCenter,
    });

    fetchZones().then(zones => {
      zones.forEach(zone => {
        const zoneLocation = { lat: zone.latitude, lng: zone.longitude };
        const marker = new google.maps.Marker({
          position: zoneLocation,
          map: map,
          title: zone.description,
        });

        google.maps.event.addListener(marker, 'click', function () {
          selectedZone = zone;
          document.getElementById('widget').classList.add('active');
          document.getElementById('zone-description').innerText = `Description: ${zone.description}`;
          document.getElementById('zone-price').innerText = `Price: ${zone.price} TND`;
          document.getElementById('zone-total-spots').innerText = `Total Spots: ${zone.totalSpots}`;
          document.getElementById('zone-available-spots').innerText = `Available Spots: ${zone.availableSpots}`;
          const reserveButton = document.getElementById('reserve-button');
          if (zone.availableSpots > 0) {
            reserveButton.classList.remove('btn-disabled');
            reserveButton.disabled = false;
          } else {
            reserveButton.classList.add('btn-disabled');
            reserveButton.disabled = true;
          }
        });
      });
    });

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
              position => {
                userLocation = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude,
                };
                map.setCenter(userLocation);
                new google.maps.Marker({
                  position: userLocation,
                  map: map,
                  title: 'Your Location',
                  icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 7,
                    fillColor: '#4285F4',
                    fillOpacity: 1,
                    strokeWeight: 2,
                  },
                });
              },
              () => {
                console.log('Geolocation service failed.');
              }
      );
    }
  }

  // Reserve and generate route
  document.getElementById('reserve-button').addEventListener('click', async function () {
    if (!selectedZone || !userLocation) return;

    try {
      const response = await fetch('http://localhost:1234/api/zones/reserve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description: selectedZone.description }),
      });

      if (!response.ok) {
        throw new Error('Failed to reserve spot');
      }

      const updatedZone = await response.json();
      document.getElementById('zone-available-spots').innerText = `Available Spots: ${updatedZone.availableSpots}`;
      selectedZone.availableSpots = updatedZone.availableSpots;

      if (updatedZone.availableSpots === 0) {
        document.getElementById('reserve-button').classList.add('btn-disabled');
        document.getElementById('reserve-button').disabled = true;
      }

      alert('Reservation successful!');

      const directionsService = new google.maps.DirectionsService();
      const directionsRenderer = new google.maps.DirectionsRenderer();
      directionsRenderer.setMap(map);

      directionsService.route(
              {
                origin: userLocation,
                destination: { lat: selectedZone.latitude, lng: selectedZone.longitude },
                travelMode: google.maps.TravelMode.DRIVING,
              },
              (result, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                  directionsRenderer.setDirections(result);
                } else {
                  alert('Could not display route: ' + status);
                }
              }
      );

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text('Reservation Details', 10, 10);
      doc.text(`Description: ${selectedZone.description}`, 10, 20);
      doc.text(`Price: ${selectedZone.price} TND`, 10, 30);
      doc.text(`Reservation Date: ${new Date().toLocaleString()}`, 10, 40);
      doc.save(`reservation_${selectedZone.description}.pdf`);

      document.getElementById('widget').classList.remove('active');
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to reserve spot.');
    }
  });

  document.getElementById('close-button').addEventListener('click', function () {
    document.getElementById('widget').classList.remove('active');
  });

  window.onload = initMap;
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
